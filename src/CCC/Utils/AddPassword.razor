@using System.Net.Mail
@using System.Security.Claims
@using CCC.Services
@using CCC.Services.Notification
@using CCC.Services.Utils
@inject IAuthService AuthService
<AuthorizeView>
    <Authorized>
        @{
            email = context.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value ?? "";
        }
        <MudOverlay Style="width:100%" @bind-Visible="_visible" ZIndex="99999" DarkBackground AutoClose="false" Absolute="true" Modal="true">
            <MudPaper Class="d-flex flex-column align-center justify-center pa-6" Style="width:40vw; height:70vh; min-width:300px">
                <MudText Typo="Typo.h6" Class="mb-4">Agregar Contraseña</MudText>
                <MudText Typo="Typo.subtitle1" Class="mb-4">Debes agregar una contraseña para tu cuenta</MudText>
                <MudPasswordField @bind-value="@_password" Label="Nueva Contraseña" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Lock" Margin="Margin.Normal" />
                <MudPasswordField @bind-value="@_confirmPassword" Label="Confirmar Contraseña" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Lock" Margin="Margin.Normal" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="LinkAccount">Guardar</MudButton>
            </MudPaper>
        </MudOverlay>
    </Authorized>
</AuthorizeView>

@code {
    private bool _visible = true;
    private string email = "";
    private string _password = "";
    private string _confirmPassword = "";


    private async void LinkAccount()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(email) || !IsValidEmail(email))
                throw new ControledException("El correo electrónico no es válido.");
            if (string.IsNullOrWhiteSpace(_password) || _password.Length < 8)
                throw new ControledException("La contraseña debe tener al menos 8 caracteres.");
            if (_password != _confirmPassword)
                throw new ControledException("Las contraseñas no coinciden.");

            await AuthService.LinkPasswordAccount(email, _password);
            _visible = false;
        }
        catch (Exception ex)
        {
            SentrySdk.CaptureException(ex);
            if(ex is ControledException)
                NotificationService.ShowWarning(ex.Message);
            else
                NotificationService.ShowError("Ocurrió un error al vincular la cuenta.");
        }
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }
}
