# .github/workflows/deploy-blazor-build.yml
name: Build Blazor & Trigger Render Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  BLAZOR_PROJECT_NAME: CCC
  BLAZOR_PROJECT_PATH: src/CCC/CCC.csproj # Ruta al archivo .csproj
  BUILD_OUTPUT_ROOT_FOLDER_NAME: deploy # Solo el nombre de la carpeta raÃ­z de salida
  # No definimos PUBLISH_DIR aquÃ­ para evitar la interpolaciÃ³n invÃ¡lida en 'env'
  # La construiremos en los pasos 'run'

jobs:
  build-and-deploy-blazor:
    name: Build Blazor & Deploy to Render
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.BLAZOR_PROJECT_PATH }}
    
    - name: Publish Blazor WebAssembly
      run: |
        # Usamos BUILD_OUTPUT_ROOT_FOLDER_NAME para el -o
        dotnet publish ${{ env.BLAZOR_PROJECT_PATH }} \
          -c Release \
          -o ${{ env.BUILD_OUTPUT_ROOT_FOLDER_NAME }} \
          /p:BasePath=/
        
        echo "âœ… Blazor WebAssembly publicado en ${{ env.BUILD_OUTPUT_ROOT_FOLDER_NAME }}"
    
    - name: Configurar URL de API
      run: |
        # Construimos la ruta completa a wwwroot dentro del script
        PUBLISH_DIR="${{ env.BUILD_OUTPUT_ROOT_FOLDER_NAME }}/wwwroot"
        cat > "$PUBLISH_DIR/appsettings.json" <<EOF
        {
          "ApiBaseUrl": "${{ secrets.API_BASE_URL }}"
        }
        EOF
        
        echo "âœ… API configurada: ${{ secrets.API_BASE_URL }}"

    - name: Configurar para Static Site
      run: |
        # Construimos la ruta completa a wwwroot dentro del script
        PUBLISH_DIR="${{ env.BUILD_OUTPUT_ROOT_FOLDER_NAME }}/wwwroot"
        touch "$PUBLISH_DIR/.nojekyll"
        cp "$PUBLISH_DIR/index.html" "$PUBLISH_DIR/404.html"
        echo "âœ… ConfiguraciÃ³n adicional para Static Site completada."

    - name: Commit y Push los archivos generados
      id: commit
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Build: Blazor WASM for Render Static Site"
        branch: main
        # El file_pattern debe apuntar a la carpeta raÃ­z de salida
        file_pattern: ${{ env.BUILD_OUTPUT_ROOT_FOLDER_NAME }}/** 

    - name: Trigger Render Frontend Deploy Hook
      run: |
        echo "ðŸš€ Triggering Render frontend deploy..."
        curl -X GET "${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}" 
        echo "âœ… Render frontend deploy hook triggered."
