# .github/workflows/deploy-blazor-build.yml
name: Build Blazor for Render Static Site

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite ejecutar manualmente

env:
  DOTNET_VERSION: '8.0.x'
  BLAZOR_PROJECT_NAME: CCC # Asegúrate de que esto coincida con el nombre de tu proyecto Blazor
  # CORRECCIÓN AQUÍ: Usamos la variable directamente en la string
  BLAZOR_PROJECT_PATH: src/CCC/CCC.csproj # Ruta al archivo .csproj. Ahora es una string literal.
  # Si quieres que sea dinámico, la mejor forma es reconstruirla en cada paso
  # o definir BLazor_Project_Path usando solo el nombre y construyendo en el run.
  DEPLOY_DIR: deploy/wwwroot # Directorio donde se almacenarán los archivos para Render

jobs:
  build-blazor:
    name: Build Blazor WebAssembly
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 

    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      # Acceso correcto a las variables de entorno dentro de un paso 'run'
      run: dotnet restore ${{ env.BLAZOR_PROJECT_PATH }}
    
    - name: Publish Blazor WebAssembly
      run: |
        dotnet publish ${{ env.BLAZOR_PROJECT_PATH }} \
          -c Release \
          -o ${{ env.DEPLOY_DIR }} \
          /p:BasePath=/
        
        echo "✅ Blazor WebAssembly publicado en ${{ env.DEPLOY_DIR }}"
    
    - name: Configurar URL de API (opcional, si Blazor lo lee de appsettings.json)
      run: |
        cat > ${{ env.DEPLOY_DIR }}/appsettings.json <<EOF
        {
          "ApiBaseUrl": "${{ secrets.API_BASE_URL }}"
        }
        EOF
        
        echo "✅ API configurada: ${{ secrets.API_BASE_URL }}"

    - name: Commit y Push los archivos generados
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Build: Blazor WASM for Render Static Site"
        branch: main
        file_pattern: ${{ env.DEPLOY_DIR }}/**
