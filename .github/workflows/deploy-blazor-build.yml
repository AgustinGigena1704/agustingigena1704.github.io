# .github/workflows/deploy-blazor-build.yml
name: Build Blazor & Trigger Render Deploy

on:
  push:
    branches: [ main ] # Se ejecuta automÃ¡ticamente en cada push a main
  workflow_dispatch: # Permite ejecutar manualmente

env:
  DOTNET_VERSION: '8.0.x'
  BLAZOR_PROJECT_NAME: CCC
  BLAZOR_PROJECT_PATH: src/CCC/CCC.csproj # Ruta al archivo .csproj
  DEPLOY_DIR: deploy # Directorio donde se almacenarÃ¡n los archivos para Render

jobs:
  build-and-deploy-blazor: # Renombramos el job
    name: Build Blazor & Deploy to Render
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # Para el git-auto-commit-action
      # No necesitas 'pages: write' ni 'id-token: write' porque ya no desplegamos en GitHub Pages directamente
      # Solo escribimos al repositorio y luego le decimos a Render que lea ese repo

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.BLAZOR_PROJECT_PATH }}
    
    - name: Publish Blazor WebAssembly
      run: |
        dotnet publish ${{ env.BLAZOR_PROJECT_PATH }} \
          -c Release \
          -o ${{ env.DEPLOY_DIR }} \
          /p:BasePath=/ # Render Static Site lo servirÃ¡ desde su raÃ­z
        
        echo "âœ… Blazor WebAssembly publicado en ${{ env.DEPLOY_DIR }}"
    
    - name: Configurar URL de API
      run: |
        cat > ${{ env.DEPLOY_DIR }}/appsettings.json <<EOF
        {
          "ApiBaseUrl": "${{ secrets.API_BASE_URL }}"
        }
        EOF
        
        echo "âœ… API configurada: ${{ secrets.API_BASE_URL }}"

    - name: Configurar para Static Site
      run: |
        touch ${{ env.DEPLOY_DIR }}/.nojekyll # Buena prÃ¡ctica para static sites
        cp ${{ env.DEPLOY_DIR }}/wwwwroot/index.html ${{ env.DEPLOY_DIR }}/wwwwroot/404.html # Muy importante para SPA routing
        echo "âœ… ConfiguraciÃ³n adicional para Static Site completada."

    - name: Commit y Push los archivos generados
      id: commit # AÃ±adimos un ID para referenciar el output
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Build: Blazor WASM for Render Static Site"
        branch: main
        file_pattern: ${{ env.DEPLOY_DIR }}/**
        # Si esta acciÃ³n no hace cambios (ej. no hay nuevos builds), no crea un commit.
        # Es importante que el siguiente paso de Render se ejecute *solo si hay un commit* o *siempre*.
        # Para la mayorÃ­a de los casos, es mejor que siempre se intente el deploy de Render si la build de Blazor fue exitosa.

    - name: Trigger Render Frontend Deploy Hook # Â¡NUEVO PASO!
      # Este paso se ejecutarÃ¡ si el paso anterior fue exitoso, independientemente de si hubo un commit.
      # Si prefieres que SOLO se dispare si hubo cambios y un commit, puedes aÃ±adir 'if: steps.commit.outputs.commit_hash'
      run: |
        echo "ðŸš€ Triggering Render frontend deploy..."
        # Usamos curl para llamar al deploy hook de Render
        curl -X GET "${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}" # Los deploy hooks de Render suelen funcionar con GET
        echo "âœ… Render frontend deploy hook triggered."
