# .github/workflows/deploy-blazor-build.yml
name: Build Blazor & Trigger Render Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  BLAZOR_PROJECT_NAME: CCC
  BLAZOR_PROJECT_PATH: src/CCC/CCC.csproj
  BUILD_OUTPUT_ROOT: deploy # La raÃ­z donde dotnet publish colocarÃ¡ su salida
  PUBLISH_DIR: ${{ env.BUILD_OUTPUT_ROOT }}/wwwroot # LA CARPETA FINAL CON LOS ARCHIVOS A SERVIR

jobs:
  build-and-deploy-blazor:
    name: Build Blazor & Deploy to Render
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.BLAZOR_PROJECT_PATH }}
    
    - name: Publish Blazor WebAssembly
      run: |
        dotnet publish ${{ env.BLAZOR_PROJECT_PATH }} \
          -c Release \
          -o ${{ env.BUILD_OUTPUT_ROOT }} \
          /p:BasePath=/ # Render Static Site lo servirÃ¡ desde su raÃ­z
        
        echo "âœ… Blazor WebAssembly publicado en ${{ env.BUILD_OUTPUT_ROOT }}"
    
    - name: Configurar URL de API
      run: |
        # Usamos PUBLISH_DIR que apunta a wwwroot
        cat > ${{ env.PUBLISH_DIR }}/appsettings.json <<EOF
        {
          "ApiBaseUrl": "${{ secrets.API_BASE_URL }}"
        }
        EOF
        
        echo "âœ… API configurada: ${{ secrets.API_BASE_URL }}"

    - name: Configurar para Static Site
      run: |
        # Usamos PUBLISH_DIR que apunta a wwwroot
        touch ${{ env.PUBLISH_DIR }}/.nojekyll
        cp ${{ env.PUBLISH_DIR }}/index.html ${{ env.PUBLISH_DIR }}/404.html
        echo "âœ… ConfiguraciÃ³n adicional para Static Site completada."

    - name: Commit y Push los archivos generados
      id: commit
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Build: Blazor WASM for Render Static Site"
        branch: main
        file_pattern: ${{ env.BUILD_OUTPUT_ROOT }}/** # Â¡IMPORTANTE! Commit de toda la carpeta 'deploy'
        # Esto asegura que todo el contenido generado en 'deploy/' se suba.

    - name: Trigger Render Frontend Deploy Hook
      run: |
        echo "ðŸš€ Triggering Render frontend deploy..."
        # Utilicemos el nombre de secret correcto, que es RENDER_FRONTEND_DEPLOY_HOOK
        curl -X GET "${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}" 
        echo "âœ… Render frontend deploy hook triggered."
